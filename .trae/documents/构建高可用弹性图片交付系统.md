# 弹性图片交付系统设计方案

为了彻底解决图片链接失效问题，我们将摒弃简单的正则替换方案，转而构建一套**弹性图片交付系统 (Resilient Image Delivery System)**。该系统包含服务端代理、智能前端组件和缓存层，确保图片加载的高可用性。

## 1. 核心架构：双通道图片加载机制
我们不再直接依赖客户端请求 GitHub 图片（易受 Referrer 策略、网络波动和 CORS 影响），而是引入**服务端智能代理**。

-   **主通道（Direct）**：尝试直接加载原始链接（性能最优）。
-   **备用通道（Proxy）**：如果主通道失败，自动切换到我们建立的 `/api/image-proxy` 服务。该服务负责：
    -   伪造合法的 Referrer/User-Agent 头。
    -   处理重定向。
    -   **[新功能] 缓存层**：将成功获取的图片缓存到本地（模拟 CDN），防止源站删除。

## 2. 健壮的存储与容灾
-   **本地缓存/CDN**：代理服务会将请求过的图片缓存。即使 GitHub 删除了原图，只要我们缓存过，用户仍能看到图片。
-   **自动回滚**：如果图片损坏，系统将自动提供预设的 "Image Not Found" 占位图，而不是破碎的图标。

## 3. 智能前端组件 (`SmartImage`)
重写 `CustomImage` 组件，实现以下状态机：
1.  **Loading**: 显示骨架屏/加载动画。
2.  **Success**: 正常显示。
3.  **Error (Retry)**: 捕获 `onError`，自动切换到 Proxy URL 重试。
4.  **Failure**: 重试仍失败，显示优雅的错误提示，并上报错误日志。

## 4. 实施步骤
1.  **后端**：开发 `/pages/api/image-proxy.js`，实现请求转发、头信息重写和简单的内存/文件缓存。
2.  **前端**：创建 `src/components/SmartImage.js`，封装自动重试和容错逻辑。
3.  **集成**：更新 `Issue.js` 和 `markdown-utils.js`，接入新系统。

此方案将彻底解决 "pnpm dev" 与 "prod" 表现不一致的问题（通常是 Referrer 差异导致的），并提供企业级的图片可靠性。